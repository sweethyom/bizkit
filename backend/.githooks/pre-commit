#!/usr/bin/env bash
set -euo pipefail

# ìŠ¤í…Œì´ì§•ëœ Java íŒŒì¼ ëª©ë¡ì„ ì•ˆì „í•˜ê²Œ ë°°ì—´ì— ì €ì¥
STAGED_FILES=()
while IFS= read -r line; do
    [[ -n "$line" ]] && STAGED_FILES+=("$line")
done < <(git diff --cached --name-only --diff-filter=ACMR | grep '\.java$' || true)

if [ ${#STAGED_FILES[@]} -eq 0 ]; then
    echo "âœ… ìŠ¤í…Œì´ì§•ëœ Java íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤!"
    exit 0
fi

# ì¤‘ë³µ ì œê±°ë¥¼ ìœ„í•œ ì¼ë°˜ ë°°ì—´ ì‚¬ìš©
MODULES_LIST=()

for FILE in "${STAGED_FILES[@]}"; do
    if [[ "$FILE" == *"/src/main/java/"* ]]; then
        # backend/ ê²½ë¡œ ì œê±° í›„ ëª¨ë“ˆ ê²½ë¡œ ìƒì„±
        MODULE_PATH=$(echo "$FILE" | sed -E 's|^backend/||' | sed -E 's|/src/main/java/.*||')
        if [ -n "$MODULE_PATH" ]; then
            MODULE=":${MODULE_PATH//\//:}"
        else
            MODULE=":"
        fi

        # ì¤‘ë³µ ì²´í¬
        if [[ ${#MODULES_LIST[@]} -eq 0 ]] || ! printf '%s\n' "${MODULES_LIST[@]}" | grep -q "^${MODULE}$"; then
            MODULES_LIST+=("$MODULE")
        fi
    fi
done

for FILE in "${STAGED_FILES[@]}"; do
    if [[ "$FILE" == *"/src/test/java/"* ]]; then
        # backend/ ê²½ë¡œ ì œê±° í›„ ëª¨ë“ˆ ê²½ë¡œ ìƒì„±
        MODULE_PATH=$(echo "$FILE" | sed -E 's|^backend/||' | sed -E 's|/src/test/java/.*||')
        if [ -n "$MODULE_PATH" ]; then
            MODULE=":${MODULE_PATH//\//:}"
        else
            MODULE=":"
        fi

        # ì¤‘ë³µ ì²´í¬
        if [[ ${#MODULES_LIST[@]} -eq 0 ]] || ! printf '%s\n' "${MODULES_LIST[@]}" | grep -q "^${MODULE}$"; then
            MODULES_LIST+=("$MODULE")
        fi
    fi
done

if [ ${#MODULES_LIST[@]} -eq 0 ]; then
    echo "âš ï¸ Spotless í¬ë§¤íŒ…ì— ì‚¬ìš©í•  ëª¨ë“ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
    exit 0
fi

UNIQUE_MODULES=()
for MODULE in "${MODULES_LIST[@]}"; do
    UNIQUE_MODULES+=("${MODULE}:spotlessApply")
done

echo "ğŸš€ Spotlessë¥¼ ë‹¤ìŒ ëª¨ë“ˆì— ëŒ€í•´ ì‹¤í–‰í•©ë‹ˆë‹¤: ${UNIQUE_MODULES[*]}"
(cd backend && ./gradlew "${UNIQUE_MODULES[@]}")

git add "${STAGED_FILES[@]}"
echo "âœ… ìŠ¤í…Œì´ì§•ëœ íŒŒì¼ì— ëŒ€í•´ í¬ë§·íŒ…ì„ ì™„ë£Œí•˜ì˜€ìŠµë‹ˆë‹¤!"
exit 0
